---
title: "xorによるPIR(秘密情報検索)の仕組み"
date: 2021-07-09 02:00:00 +0900
---

# xorによるPIR(秘密情報検索)の仕組み

## PIRとは

PIR(Private Information Retrieval)は、秘密情報を検索する手法です。
何らかのサーバー（キーバリューストア/KVS）に対して「Aというキーを持つデータをください」と尋ねることで、Aというデータが取得できます。ただし、サーバーにはあなたがAというデータを取得したことがバレてしまいます。
これを、サーバーにバレないように、でもAを取得しましょう、というのが秘密情報検索です。

## xorの性質

xorぐらい知ってるわ！という方はスキップしてください。

xor演算は、以下のような性質があります。

`A xor B = C`

|A|B|**C**|
|:-:|:-:|:-:|
|0|0|**0**|
|0|1|**1**|
|1|0|**1**|
|1|1|**0**|

xorには、交換法則や結合法則が成り立ちます。
つまり、

- `A xor B = B xor A`
- `A xor (B xor C) = (A xor B) xor C`

分配法則は成り立ちません

`A xor (B xor C) != (A xor B) xor (A xor C)`


xorには、同じ演算を2回行うと元に戻る性質があります。

- `(A xor B) xor B == A`
- `A xor B xor B xor C xor C == A`

AやBが1ビットではなく8ビットや16ビットでも成り立ちます。各ビットごとにxor演算するだけです。

`0101 xor 1100 = 1001`

## xorによるPIR

### 1. 前提

まず、自然数をキーに、バイナリをバリューとするようなKVSがあるとします。大きさが200個ぐらいと仮定します。つまり1~200番までデータが入っています。
一つ一つのデータは1KBの固定長とします。
また、KVS全体は各サーバーが同じものを持っているします。(ここで、Value(x)はxのバリューを返す関数とします)

|Key|Value|
|:-:|:-:|
|1|Value(1)|
|2|Value(2)|
|...|...|
|200|Value(200)|

また、今回はクライアントはKey=3のデータである`Value(3)`が欲しいとします。

### 2.　要求

クライアントは、各サーバーに欲しいデータのキーを複数連絡します。

- `クライアント -> サーバーA` 「1番と6番のデータください！」
- `クライアント -> サーバーB` 「3番と5番と6番のデータください！」
- `クライアント -> サーバーC` 「5番と1番のデータください！」

この時、どのサーバーにどんな番号のキーを要求してもいいです。何個指定してもいいです。ただし、合計で要求する数が、欲しいデータは奇数、欲しくないデータは偶数に指定するとします。
今回欲しくない1・5・6番は合計2回（偶数）、欲しい3番は合計1回(奇数)指定しています。

### 3. 返信

各サーバーは、クライアントにデータを返信しますが、その際に要求されたデータをxorして返却します。

- `サーバーA -> クライアント` 「`Value(1) xor Value(6)`をあげるよ！」
- `サーバーB -> クライアント` 「`Value(3) xor Value(5) xor Value(6)`をあげるよ！」
- `サーバーC -> クライアント` 「`Value(5) xor Value(1)`をあげるよ！」

### 4. 合成

クライアントは、帰ってきたデータを全てxorします。(Valueが見にくいのでVと省略しました)

`( V(1) xor V(6) ) xor ( V(3) xor V(5) xor V(6) ) xor ( V(5) xor V(1) )`

ところでxorには、同じデータを2回xorすると元に戻る性質があります。つまり、式の中に偶数個出現している項は消せます。
なので、

- `( V(1) xor V(6) ) xor ( V(3) xor V(5) xor V(6) ) xor ( V(5) xor V(1) )`
- `= V(1) xor V(6)  xor  V(3) xor V(5) xor V(6)  xor  V(5) xor V(1) `
- `= V(1) xor V(1) xor V(3) xor V(5) xor V(5) xor V(6) xor V(6)`
- `= V(3) xor V(5) xor V(5) xor V(6) xor V(6)`
- `= V(3) xor V(6) xor V(6)`
- `= V(3)`

これで、目的であるV(3)のみ取得できました。

> ただし、合計で要求する数が、欲しいデータは奇数、欲しくないデータは偶数に指定するとします。

と冒頭に指定したのはこのためです。

## まとめ

これで、自分の知りたいデータが(1,3,5,6の中から)どれかをサーバー知らせずに情報検索ができました。理論上は、このデータ数を数百・数千と増やしていくことで確率を増やし、プライバシーを高めることができます。
これが、xorによるPIRです。
