---
title: "xorによるPIR(秘密情報検索)の仕組み"
date: 2021-07-09 02:11:00 +0900
---

当時ゼニポタプロジェクトで起こっていたことについて
===

音崎くんが3年前に公開したこの記事(おのかちお解任に関する話)について、自分の知り合いへ事の顛末を説明することが多いのでここに書き残しておく。

https://maiplelab.hatenablog.com/entry/2018/10/20/175721
https://maiplelab.hatenablog.com/entry/2019/05/19/233918

また、当時非公開になっていた事の顛末についてもここで全て記しておく。

## ゼニポタプロジェクトについて

2017~2018年ごろ、音咲アリスくん、ふじしゃん、もう2人の4人で「ゼニポタ」という暗号通貨の商品売買サービスを開発していた。
そこでブロックチェーンとWebアプリケーションの繋ぎこみについて自分に相談が来て、結果的にブロックチェーンエンジニアとして自分がプロジェクトに参加することになった。

この時点で、各自の役割が以下だった。

- 自分: ブロックチェーンエンジニア
- 音崎くん:デザイナー
- ふじしゃん: プロジェクトリーダー
- 他2人: エンジニア

当初はcoindとバックエンドのつなぎ込みについて自分は担当する予定であった。

また、自分が抜けたあとに2名が参加した。

## 事件1. ユーザー管理について

自分の参加当初、バックエンドで実装されていたアカウントの処理を読んだところ、ミドルウェアを使わずに自力で実装されていた。
生SQL呼び出しに、インデックスやプライマリキーの貼られていないデータベース、その他脆弱性やパフォーマンスに問題が在るコードが見られた。

そのため、アカウントについては自分たちで実装せずに素直に他のミドルウェアを使うことを提案し、受け入れられたが、そのミドルウェアは自分が選定することになった。
またその過程で、巨大なバックエンドサーバーを使わずに、認証や各サービスを分割し、マイクロアーキテクチャ的（正確には分散モノリス）にしたほうが開発効率が上がる、とも提案した。
この時点で自分にタスクが集中していく。
このときメンバーから「TwitterやGoogleでOAuthログインを行いたい」という要望があり、そこも含めてリサーチを行うことになった。
結果的に、AWSのcognitoを利用してアカウント管理を外部に委託するのがセキュリティ的にも機能的にも良いと判断し、cognitoを使うことに決定した。

ただ、このときアカウント管理を実装した人間から「自分の書いたコードは無駄だったのか」「大変だった」「書いたコードを捨てたくない」と言われ、自分とふじしゃんが説得を行った。
今思えばこの時点で不和が始まっていたと考えられる。
また、業務でのプログラミング経験が在るメンバーが居ない中、容易に分散モノリスとモジュール化を提案したのは間違いだった。

## 事件2. Cognitoの利用について

Cognito採用が決定した後、（ブロックチェーンエンジニアのはずの）自分がアカウント周りを実装することになった。
当時はAWSを触るのが初めてなところ、cognito自体のセットアップに時間がかかっていて時間を費やしても何も成果が生まれていなかったところ、アカウントの実装は他に影響が在るので早くして欲しい、やもっと作業をしてくれ、等をメンバーから言われ、若干嫌気が差していた。
ただ、結果的にCognitoリソース自体は作れたが、その後自分はコードを書いたところで嬉しがりもされず遅ければ文句を言われるんだなぁ…との考えに陥り、次第にゼニポタに費やす時間を減らしていった。

今思えば、このときに断固として自分はアカウントの実装をしない、ブロックチェーンの実装しかしない、という意思表示ができていれば、タスクが減り、もう少し頑張れたのかもしれない。

## 事件3. アーキテクチャについて

自分が分散モノリスを提案したあたりから、自分が全体のアーキテクチャを考えることになった。データベースの実装から、各サービスのAPI、Backend for Frontendの機能まで一人で抱え込むことになった。
この頃の自分はこれらの技術を採用したことがなく、学習コストも大変大きかったため、時間を掛けてインプットを行っていた。今思えばこの時点で元のモノリスに戻すべきであった。
インプットに時間をかけるがアウトプットが生まれない状況になり、またアカウントによらない別の部分での実装のタスクも振ってきて、完全にタスクが集中過多になった。

この時点でバックエンドとロジックを実装する人間が僕とふじしゃんのみになっていた。

## 事件4. フロントエンドとバックエンドのリポジトリ決別について

当時、デザイナーであった音崎くんは、htmlとcssとcssフレームワークを用いて、フロントエンドを開発していた。開発と行っても、ajaxを使うjsを書くわけでもなく、ただ完成したアプリケーション画面のhtmlを作るという作業だった。つまり静的なページである。
そのファイルを渡されたバックエンド開発者が、フレームワークのviews/以下にそのファイルを置き、テンプレートエンジンを使い、htmlで固定であったユーザー名やコンテンツ、カードの中身をphpから書き出す作業を行った。

このとき、githubリポジトリがフロントエンドとバックエンドで2分していた。例えばこれがWeb APIで接続するVue.jsとLaravelの様な組み合わせであるならばこの構成でもいいが、今はマークアップを置いてあるリポジトリから手作業でバックエンドのviews/以下にコピーする作業が発生しており無駄だった。
自分は、バックエンドのリポジトリに統合し、今後はマークアップをviews/以下にコミットしてもらうように音崎くんに提案したが、受け入れてもらえなかった。またふじしゃんも統合に強く賛同してくれなかったため、結局分割して開発することになった。
この時点でマークアップが更新されるたびにコピーを行う作業が発生して、バックエンドでの開発効率が低下していた。

また、音咲くんはPHPがかける人間であったが、なぜかデザイナーを専任し、マークアップを書く仕事に専念していた。つまり、タスクは過多だが、それを昇華できる人間が一部しか居らず、僕とふじしゃんのみ忙しくて、音崎くんはそうでもない、と行った状況になっていた。

## 事件5. おのかちおの解任について

この時期からゼニポタに愛想を尽かして他のタスクを専念していた。（ここで明確に辞めなかった自分が悪いが。）
当時TwitterのDMグループが主な開発チャットになっていたが、僕がTwitterのDMの確認率が悪いことを原因としてSlackに乗り換えることとなった。
ただチャットをSlackへ移行後、自分はSlackへログインせず、作業を放置することにした。
数日後Slackを見るように催促され、それでも見なかったところ、チャットがSlackからTwitterのDMへ戻った。
ここで、メンバーから「これからは積極的にコミットするように宣言してくれ」と言われたため、宣言をした。ここで宣言せずに自分から脱退すればより早くメンバーの開発が進んだかもしれない。
その後も結局自分はDMを見ずに作業を放棄する。

しばらくしたのち、急にメンバーから「おのかちおを解任します。」と連絡が来て、TwitterのDMとgithubのオーガニゼーションから削除された。

## その後

ゼニポタプロジェクトのメンバーで三洋電産というチームを作り、その配下にゼニポタプロジェクトが置かれるようになった。

https://monacuration.com/post-2250/

がその後、音崎くん含めた他のメンバーは脱退した模様。
ふじしゃんは一人でSecHack365ハッカソンに参加しゼニポタの開発を続行した。

https://vimeo.com/458620961

その後はふじしゃんから稀にブロックチェーンの署名についての相談などが来て、自分はできる範囲で答えているが、特に実装などには参加していない状況である。

## この騒動のまとめ

事の顛末としては、

- 技術力に見合っていない開発をしていた高校生たち
- 手に負えないソフトウェアと手に負えないアーキテクチャを採用してしまったチーム
- 各自のスキルに適切に合わせてタスク分担ができていないふじしゃん
- 開発をせず、タスクを抱え込み、それでも自分から明確に辞めると言わなかった自分
- 開発に参加できたのにデザイナータスクしか行わなかった音崎くん
- 不用意に口を出して自分の仕事を増やしてしまった自分
- 過去に書いたコードを捨てきれずに開発から足が遠のいてしまった他のエンジニア

などがゼニポタが失敗した主な原因として挙げられる。

こうして見ると、全員に非が在るのかどうかは定かではないが、少なくともタスクを放棄した自分はふじしゃん初めメンバー全員に迷惑を掛けてしまっていたんだと思う。
改めてここで謝罪しておきたい。ごめんなさい。
